!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("axios"),require("lodash/compact"),require("lodash/isEqual"),require("lodash/isEmpty")):"function"==typeof define&&define.amd?define(["axios","lodash/compact","lodash/isEqual","lodash/isEmpty"],t):e.LayerManager=t(e.axios,e.compact,e.isEqual,e.isEmpty)}(this,function(d,o,r,l){"use strict";var n="default"in d?d.default:d;o=o&&o.hasOwnProperty("default")?o.default:o,r=r&&r.hasOwnProperty("default")?r.default:r,l=l&&l.hasOwnProperty("default")?l.default:l;var a=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),y=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},i={"Content-Type":"application/json"},f=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return n.get(e,y({headers:i},t))},s=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=e;return Object.keys(t).forEach(function(e){n=n.replace(new RegExp("{{"+e+"}}","g"),t[e]).replace(new RegExp("{"+e+"}","g"),t[e])}),n},u=function(e){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},t=e,r=void 0;return Object.keys(i).forEach(function(n){r=(r=""+o(Object.keys(i[n]).map(function(e){var t=i[n][e];return Array.isArray(t)&&t.length?e+" IN ("+t.map(function(e){return"number"!=typeof e?"'"+e+"'":e}).join(", ")+")":!Array.isArray(t)&&t?"number"!=typeof t?e+" = '"+t+"'":e+" = "+t:null})).join(" AND "))&&n.startsWith("where")?"WHERE "+r:r&&n.startsWith("and")?"AND "+r:"",t=(t=t.replace(new RegExp("{{"+n+"}}","g"),r)).replace(new RegExp("{"+n+"}","g"),r)}),t},m=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=e;return"string"==typeof i&&(i=s(i,t),i=u(i,n)),i},c=function(e){var t=e.layerConfig,n=e.params,i=e.sqlParams,r=e.interactivity,o=!1===t.parse?t:JSON.parse(m(JSON.stringify(t),n,i)),a=JSON.stringify({version:"1.3.0",stat_tag:"API",layers:o.body.layers.map(function(e){return r&&r.length?y({},e,{options:y({},e.options,{interactivity:r.split(", ")})}):e})}),s="?stat_tag=API&config="+encodeURIComponent(a),u="https://"+o.account+"-cdn.resilienceatlas.org/user/ra/api/v1/map"+s,c=e.layerRequest;c&&c.cancel("Operation canceled by the user.");var l=d.CancelToken.source();return e.set("layerRequest",l),f(u,{cancelToken:l.token}).then(function(e){return 400<e.status?(console.error(e),!1):e.data})},h=("undefined"!=typeof window?window:{}).L,p=function(e){if(!h)throw new Error("Leaflet must be defined.");var t=e.layerConfig,n=e.params,i=e.sqlParams;e.interactivity,!1===t.parse||JSON.parse(m(JSON.stringify(t),n,i));return new Promise(function(i,t){c(e).then(function(e){var t="https://"+e.cdn_url.https+"/ra/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png",n=h.tileLayer(t);return i(n)}).catch(function(e){return t(e)})})};p.getBounds=function(e){if(!h)throw new Error("Leaflet must be defined.");return function(e){var t=e.layerConfig,n=e.params,i=e.sqlParams,r=e.type,o=e.sql;"raster"===r&&(o="SELECT ST_Union(ST_Transform(ST_Envelope(the_raster_webmercator), 4326)) as the_geom FROM ("+o+") as t");var a="\n    SELECT ST_XMin(ST_Extent(the_geom)) as minx,\n    ST_YMin(ST_Extent(the_geom)) as miny,\n    ST_XMax(ST_Extent(the_geom)) as maxx,\n    ST_YMax(ST_Extent(the_geom)) as maxy\n    from ("+o+") as subq\n  ",s="https://"+(!1===t.parse?t:JSON.parse(m(JSON.stringify(t),n,i))).account+"-cdn.resilienceatlas.org/user/ra/api/v2/sql?q="+a.replace(/\n/g," "),u=e.boundsRequest;u&&u.cancel("Operation canceled by the user.");var c=d.CancelToken.source();return e.set("boundsRequest",c),f(s,{cancelToken:c.token}).then(function(e){return 400<e.status?(console.error(e),!1):e.data})}(e).then(function(e){var t=e.rows[0];return[[t.maxy,t.maxx],[t.miny,t.minx]]})};var v=("undefined"!=typeof window?window:{}).L,g=v&&v.GridLayer.extend({tiles:{},createTile:function(e,t){for(var n=this,i=e.x,r=e.y,o=e.z,a=this.options.params,s=m(a.url,y({x:i,y:r,z:o},a)),u=Object.keys(this.tiles),c=0;c<u.length;c++)this.tiles[u[c]].z!==o&&delete this.tiles[u[c]];this.done=t;var l=v.DomUtil.create("canvas","leaflet-tile"),h=l.getContext("2d"),p=this.getTileSize();return l.width=p.x,l.height=p.y,this.getTile({x:i,y:r,z:o}).then(function(e){n.cacheTile(y({id:s,tile:l,ctx:h,image:e},{x:i,y:r,z:o})),n.drawCanvas(s),t(null,l)}).catch(function(e){t(e,l)}),l},getTile:function(e){var t=this,n=e.x,i=e.y,r=e.z,o=this.options,a=o.params,s=o.sqlParams,u=a.url,c=a.dataMaxZoom,l=void 0===c?20:c,h=r-l,p=m(a.url,y({x:n,y:i,z:r},a)),d={x:n,y:i,z:r};0<h&&(d={x:Math.floor(n/Math.pow(2,h)),y:Math.floor(i/Math.pow(2,h)),z:l});var f=m(u,y({},d,a),s);return new Promise(function(r,o){t.tiles[p]&&r(t.tiles[p].image);var e=new XMLHttpRequest;e.addEventListener("load",function(e){var t=e.currentTarget.response,n=URL.createObjectURL(t),i=new Image;i.src=n,i.onload=function(){i.crossOrigin="",r(i),URL.revokeObjectURL(n)},i.onerror=function(){o(new Error("Can't load image"))}}),e.addEventListener("error",o),e.open("GET",f,!0),e.responseType="blob",e.send()})},cacheTile:function(e){this.tiles[e.id]=y({},this.tiles[e.id],e)},drawCanvas:function(e){"use asm";if(!this.tiles[e]){return}var t=this.tiles[e],n=t.tile,i=t.ctx,r=t.image,o=t.x,a=t.y,s=t.z;if(!n||!i||!r||typeof o==="undefined"||typeof a==="undefined"||typeof s==="undefined"){delete this.tiles[e];return}var u=this.options,c=u.params,l=u.decodeParams,h=u.decodeFunction;var p=c.dataMaxZoom,d=p===undefined?20:p;var f=s-d;i.clearRect(0,0,n.width,n.width);if(f<0){i.drawImage(r,0,0)}else{i.imageSmoothingEnabled=false;i.mozImageSmoothingEnabled=false;var y=n.width/Math.pow(2,f)*(o%Math.pow(2,f))||0;var m=n.height/Math.pow(2,f)*(a%Math.pow(2,f))||0;var v=n.width/Math.pow(2,f)||0;var g=n.height/Math.pow(2,f)||0;i.drawImage(r,y,m,v,g,0,0,n.width,n.height)}var w=i.getImageData(0,0,n.width,n.height);if(typeof h==="function"){h(w.data,n.width,n.height,s,l)}i.putImageData(w,0,0)},reDraw:function(e){var a=this;this.options.params=e.params,this.options.sqlParams=e.sqlParams,this.options.decodeParams=e.decodeParams;var s=e.params,u=e.sqlParams;s&&s.url&&Object.keys(this.tiles).map(function(e){var t=a.tiles[e],n=t.x,i=t.y,r=t.z,o=m(s.url,y({x:n,y:i,z:r},s,{sqlParams:u}));return a.drawCanvas(o)})}});function w(e,t,n,i,r,o){if(!(r-i<=n)){var a=Math.floor((i+r)/2);!function e(t,n,i,r,o,a){for(;r<o;){if(600<o-r){var s=o-r+1,u=i-r+1,c=Math.log(s),l=.5*Math.exp(2*c/3),h=.5*Math.sqrt(c*l*(s-l)/s)*(u-s/2<0?-1:1),p=Math.max(r,Math.floor(i-u*l/s+h)),d=Math.min(o,Math.floor(i+(s-u)*l/s+h));e(t,n,i,p,d,a)}var f=n[2*i+a],y=r,m=o;for(L(t,n,r,i),n[2*o+a]>f&&L(t,n,r,o);y<m;){for(L(t,n,y,m),y++,m--;n[2*y+a]<f;)y++;for(;n[2*m+a]>f;)m--}n[2*r+a]===f?L(t,n,r,m):L(t,n,++m,o),m<=i&&(r=m+1),i<=m&&(o=m-1)}}(e,t,a,i,r,o%2),w(e,t,n,i,a-1,o+1),w(e,t,n,a+1,r,o+1)}}function L(e,t,n,i){x(e,n,i),x(t,2*n,2*i),x(t,2*n+1,2*i+1)}function x(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function b(e,t,n,i){var r=e-n,o=t-i;return r*r+o*o}function O(e,t,n,i,r){return new E(e,t,n,i,r)}function E(e,t,n,i,r){t=t||P,n=n||k,r=r||Array,this.nodeSize=i||64,this.points=e,this.ids=new r(e.length),this.coords=new r(2*e.length);for(var o=0;o<e.length;o++)this.ids[o]=o,this.coords[2*o]=t(e[o]),this.coords[2*o+1]=n(e[o]);w(this.ids,this.coords,this.nodeSize,0,this.ids.length-1,0)}function P(e){return e[0]}function k(e){return e[1]}function M(e){this.options=T(Object.create(this.options),e),this.trees=new Array(this.options.maxZoom+1)}function C(e){return{type:"Feature",id:e.id,properties:_(e),geometry:{type:"Point",coordinates:[(i=e.x,360*(i-.5)),(t=e.y,n=(180-360*t)*Math.PI/180,360*Math.atan(Math.exp(n))/Math.PI-90)]}};var t,n,i}function _(e){var t=e.numPoints,n=1e4<=t?Math.round(t/1e3)+"k":1e3<=t?Math.round(t/100)/10+"k":t;return T(T({},e.properties),{cluster:!0,cluster_id:e.id,point_count:t,point_count_abbreviated:n})}function S(e){return e/360+.5}function I(e){var t=Math.sin(e*Math.PI/180),n=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return n<0?0:1<n?1:n}function T(e,t){for(var n in t)e[n]=t[n];return e}function z(e){return e.x}function q(e){return e.y}M.prototype={options:{minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!(E.prototype={range:function(e,t,n,i){return function(e,t,n,i,r,o,a){for(var s,u,c=[0,e.length-1,0],l=[];c.length;){var h=c.pop(),p=c.pop(),d=c.pop();if(p-d<=a)for(var f=d;f<=p;f++)s=t[2*f],u=t[2*f+1],n<=s&&s<=r&&i<=u&&u<=o&&l.push(e[f]);else{var y=Math.floor((d+p)/2);s=t[2*y],u=t[2*y+1],n<=s&&s<=r&&i<=u&&u<=o&&l.push(e[y]);var m=(h+1)%2;(0===h?n<=s:i<=u)&&(c.push(d),c.push(y-1),c.push(m)),(0===h?s<=r:u<=o)&&(c.push(y+1),c.push(p),c.push(m))}}return l}(this.ids,this.coords,e,t,n,i,this.nodeSize)},within:function(e,t,n){return function(e,t,n,i,r,o){for(var a=[0,e.length-1,0],s=[],u=r*r;a.length;){var c=a.pop(),l=a.pop(),h=a.pop();if(l-h<=o)for(var p=h;p<=l;p++)b(t[2*p],t[2*p+1],n,i)<=u&&s.push(e[p]);else{var d=Math.floor((h+l)/2),f=t[2*d],y=t[2*d+1];b(f,y,n,i)<=u&&s.push(e[d]);var m=(c+1)%2;(0===c?n-r<=f:i-r<=y)&&(a.push(h),a.push(d-1),a.push(m)),(0===c?f<=n+r:y<=i+r)&&(a.push(d+1),a.push(l),a.push(m))}}return s}(this.ids,this.coords,e,t,n,this.nodeSize)}}),reduce:null,initial:function(){return{}},map:function(e){return e}},load:function(e){var t=this.options.log;t&&console.time("total time");var n="prepare "+e.length+" points";t&&console.time(n),this.points=e;for(var i,r,o,a=[],s=0;s<e.length;s++)e[s].geometry&&a.push((i=e[s],r=s,void 0,{x:S((o=i.geometry.coordinates)[0]),y:I(o[1]),zoom:1/0,index:r,parentId:-1}));this.trees[this.options.maxZoom+1]=O(a,z,q,this.options.nodeSize,Float32Array),t&&console.timeEnd(n);for(var u=this.options.maxZoom;u>=this.options.minZoom;u--){var c=+Date.now();a=this._cluster(a,u),this.trees[u]=O(a,z,q,this.options.nodeSize,Float32Array),t&&console.log("z%d: %d clusters in %dms",u,a.length,+Date.now()-c)}return t&&console.timeEnd("total time"),this},getClusters:function(e,t){var n=((e[0]+180)%360+360)%360-180,i=Math.max(-90,Math.min(90,e[1])),r=180===e[2]?180:((e[2]+180)%360+360)%360-180,o=Math.max(-90,Math.min(90,e[3]));if(360<=e[2]-e[0])n=-180,r=180;else if(r<n){var a=this.getClusters([n,i,180,o],t),s=this.getClusters([-180,i,r,o],t);return a.concat(s)}for(var u=this.trees[this._limitZoom(t)],c=u.range(S(n),I(o),S(r),I(i)),l=[],h=0;h<c.length;h++){var p=u.points[c[h]];l.push(p.numPoints?C(p):this.points[p.index])}return l},getChildren:function(e){var t=e>>5,n=e%32,i="No cluster with the specified id.",r=this.trees[n];if(!r)throw new Error(i);var o=r.points[t];if(!o)throw new Error(i);for(var a=this.options.radius/(this.options.extent*Math.pow(2,n-1)),s=r.within(o.x,o.y,a),u=[],c=0;c<s.length;c++){var l=r.points[s[c]];l.parentId===e&&u.push(l.numPoints?C(l):this.points[l.index])}if(0===u.length)throw new Error(i);return u},getLeaves:function(e,t,n){t=t||10,n=n||0;var i=[];return this._appendLeaves(i,e,t,n,0),i},getTile:function(e,t,n){var i=this.trees[this._limitZoom(e)],r=Math.pow(2,e),o=this.options.extent,a=this.options.radius/o,s=(n-a)/r,u=(n+1+a)/r,c={features:[]};return this._addTileFeatures(i.range((t-a)/r,s,(t+1+a)/r,u),i.points,t,n,r,c),0===t&&this._addTileFeatures(i.range(1-a/r,s,1,u),i.points,r,n,r,c),t===r-1&&this._addTileFeatures(i.range(0,s,a/r,u),i.points,-1,n,r,c),c.features.length?c:null},getClusterExpansionZoom:function(e){for(var t=e%32-1;t<this.options.maxZoom;){var n=this.getChildren(e);if(t++,1!==n.length)break;e=n[0].properties.cluster_id}return t},_appendLeaves:function(e,t,n,i,r){for(var o=this.getChildren(t),a=0;a<o.length;a++){var s=o[a].properties;if(s&&s.cluster?r+s.point_count<=i?r+=s.point_count:r=this._appendLeaves(e,s.cluster_id,n,i,r):r<i?r++:e.push(o[a]),e.length===n)break}return r},_addTileFeatures:function(e,t,n,i,r,o){for(var a=0;a<e.length;a++){var s=t[e[a]],u={type:1,geometry:[[Math.round(this.options.extent*(s.x*r-n)),Math.round(this.options.extent*(s.y*r-i))]],tags:s.numPoints?_(s):this.points[s.index].properties},c=s.numPoints?s.id:this.points[s.index].id;void 0!==c&&(u.id=c),o.features.push(u)}},_limitZoom:function(e){return Math.max(this.options.minZoom,Math.min(e,this.options.maxZoom+1))},_cluster:function(e,t){for(var n=[],i=this.options.radius/(this.options.extent*Math.pow(2,t)),r=0;r<e.length;r++){var o=e[r];if(!(o.zoom<=t)){o.zoom=t;var a=this.trees[t+1],s=a.within(o.x,o.y,i),u=o.numPoints||1,c=o.x*u,l=o.y*u,h=null;this.options.reduce&&(h=this.options.initial(),this._accumulate(h,o));for(var p=(r<<5)+(t+1),d=0;d<s.length;d++){var f=a.points[s[d]];if(!(f.zoom<=t)){f.zoom=t;var y=f.numPoints||1;c+=f.x*y,l+=f.y*y,u+=y,f.parentId=p,this.options.reduce&&this._accumulate(h,f)}}1===u?n.push(o):(o.parentId=p,n.push({x:c/u,y:l/u,zoom:1/0,id:p,parentId:-1,numPoints:u,properties:h}))}}return n},_accumulate:function(e,t){var n=t.numPoints?t.properties:this.options.map(this.points[t.index].properties);this.options.reduce(e,n)}};var j=("undefined"!=typeof window?window:{}).L,Z={50:25,100:30,1e3:40},A=j&&j.GeoJSON.extend({initialize:function(e){var n=this,t=this;j.GeoJSON.prototype.initialize.call(this,[]);var i=e.layerConfig,a=e.events,r=e.decodeClusters;if(r){var o=e.layerConfig||{},s=o.html,u=o.sizes,c=void 0===u?Z:u,l=o.clusterIcon,h=o.icon;j.Util.setOptions(this,{pointToLayer:function(e,t){if(!(e.properties&&e.properties.cluster))return j.marker(t,{icon:j.icon(y({iconSize:[35,35]},h))});var n=e.properties.point_count,i=null;if("function"==typeof c)i=function(){return c(n)};else{var r=Object.keys(c).find(function(e){return n<=parseInt(e,10)}),o=c[r];i=j.point(o,o)}return j.marker(t,{icon:j.divIcon(y({iconSize:i,html:s&&"function"==typeof s?s(e):'<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; '+(l.color?"background-color: "+l.color+";":"")+'">'+e.properties.point_count_abbreviated+"</div>"},l))})},onEachFeature:function(o,e){o.properties&&o.properties.cluster?e.on({click:function(){return t.setMapView(o)}}):a&&e.on(Object.keys(a).reduce(function(e,t){return y({},e,(r=function(e){return a[t](y({},e,{data:o.properties}))},(i=t)in(n={})?Object.defineProperty(n,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[i]=r,n));var n,i,r},{}))}});var p=(i||{}).clusterConfig;this.supercluster=new M(y({radius:80,maxZoom:16},p)),function(e){var t=e.layerConfig,n=e.layerRequest,i=t.body.url;n&&n.cancel("Operation canceled by the user.");var r=d.CancelToken.source();return e.set("layerRequest",r),f(i,{cancelToken:r.token}).then(function(e){return 400<e.status?(console.error(e),!1):e.data})}(e).then(function(e){var t=r(e);n.supercluster.load(t),n.update()})}else console.warn("You must provide a decodeClusters function")},setMapView:function(e){var t=e.geometry.coordinates,n=this.supercluster.getClusterExpansionZoom(e.properties.cluster_id);this._map.setView(t.reverse(),n)},onAdd:function(e){j.GeoJSON.prototype.onAdd.call(this,e),e.on("moveend zoomend",this.onMove,this)},onRemove:function(e){e.off("moveend zoomend",this.onMove,this),this.clear()},onMove:function(){this.clear(),this.update()},update:function(){var e=this._map.getZoom(),t=this._map.getBounds(),n=[t._southWest.lng,t._southWest.lat,t._northEast.lng,t._northEast.lat],i=this.supercluster.getClusters(n,e);this.addData(i)},clear:function(){j.GeoJSON.prototype.clearLayers.call(this,[])}}),N=("undefined"!=typeof window?window:{}).L,R=N&&N.GridLayer.extend({tiles:{},cache:{},mouseOn:null,createTile:function(e){for(var t=e.z,n=Object.keys(this.tiles),i=0;i<n.length;i++)this.tiles[n[i]].z!==t&&delete this.tiles[n[i]];var r=N.DomUtil.create("div","leaflet-tile"),o=this.getTileSize();return r.width=o.x,r.height=o.y,r},onAdd:function(e){N.GridLayer.prototype.onAdd.call(this,e),this.map=e;var t=Math.round(this.map.getZoom());t>this.options.maxZoom||t<this.options.minZoom||(e.on("click",this.click,this),e.on("mousemove",this.move,this))},onRemove:function(){var e=this.map;e.off("click",this.click,this),e.off("mousemove",this.move,this)},click:function(e){this.fire("click",this.objectForEvent(e))},move:function(e){var t=this.objectForEvent(e);t.data!==this.mouseOn?(this.mouseOn&&this.fire("mouseout",{latlng:e.latlng,data:this.mouseOn}),t.data&&this.fire("mouseover",t),this.mouseOn=t.data):t.data&&this.fire("mousemove",t)},objectForEvent:function(e){return N.extend({latlng:e.latlng,data:null},e)}}),J=("undefined"!=typeof window?window:{}).L,D=eval,B=function(e){if(!J)throw new Error("Leaflet must be defined.");var t=e.layerConfig,n=e.params,i=e.sqlParams,r=e.decodeParams,o=e.interactivity,a=void 0,s=!1===t.parse?t:JSON.parse(m(JSON.stringify(t),n,i));switch(s.body.crs&&J.CRS[s.body.crs]&&(s.body.crs=J.CRS[s.body.crs.replace(":","")],s.body.pane="tilePane"),s.type){case"wms":a=J.tileLayer.wms(s.url||s.body.url,s.body);break;case"tileLayer":if(0<=JSON.stringify(s.body).indexOf('style: "function')&&(s.body.style=D("("+s.body.style+")")),a=r&&s.canvas?new g(y({},e)):J.tileLayer(s.url||s.body.url,s.body),o){var u=new R,c=J.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});a=new c([a,u])}break;case"cluster":0<=JSON.stringify(s.body).indexOf('style: "function')&&(s.body.style=D("("+s.body.style+")")),a=new A(e);break;default:a=J[s.type](s.body,s.options||{})}return new Promise(function(e,t){a?e(a):t(new Error('"type" specified in layer spec doesn`t exist'))})},F=("undefined"!=typeof window?window:{}).L,G=eval,U=function(a){if(!F)throw new Error("Leaflet must be defined.");if(!F.esri)throw new Error("To support this layer you should add esri library for Leaflet.");var e=a.layerConfig,s=a.interactivity,t=a.params,n=a.sqlParams,u=!1===e.parse?e:JSON.parse(m(JSON.stringify(e),t,n)),c=JSON.stringify(u.body||{}).replace(/"mosaic-rule":/g,'"mosaicRule":').replace(/"mosaic_rule":/g,'"mosaicRule":').replace(/"use-cors":/g,'"useCors":').replace(/"use_cors":/g,'"useCors":');return F[u.type]?new B(y({},a)):new Promise(function(e,t){if(!F.esri[u.type])return t(new Error('"type" specified in layer spec doesn`t exist'));var n=JSON.parse(c);n.pane="tilePane",n.useCors=!0,n.style&&0<=n.style.indexOf("function")&&(n.style=G("("+n.style+")"));var i=void 0;if(!(i=F.esri[u.type](n)))return t();if(i.on("load",function(){i.setZIndex(a.zIndex)}),i.on("requesterror",function(e){return console.error(e)}),i.setZIndex||(i.setZIndex=function(e){i._currentImage&&(i._currentImage._image.style.zIndex=e)}),s){var r=new R,o=F.LayerGroup.extend({group:!0,setOpacity:function(t){a.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});i=new o([i,r])}return e(i)})},V=("undefined"!=typeof window?window:{}).L,W=function(e){if(!V)throw new Error("Leaflet must be defined.");var t=e.id,n=e.layerConfig,i=e.interactivity,r=e.params,o=e.sqlParams,a=e.decodeParams,s="https://api.resourcewatch.org/v1/layer/"+t+"/tile/gee/{z}/{x}/{y}",u=!1===n.parse?n:JSON.parse(m(JSON.stringify(n),r,o)),c=void 0;switch(u.type){case"tileLayer":c=a?new g(y({},e)):V.tileLayer(s,u.body);break;default:c=V.tileLayer(s,u.body)}if(i){var l=new R,h=V.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});c=new h([c,l])}return new Promise(function(e,t){c?e(c):t(new Error('"type" specified in layer spec doesn`t exist'))})},H=("undefined"!=typeof window?window:{}).L,X=H&&new H.LatLngBounds(new H.LatLng(49.496674527470454,-66.357421875),new H.LatLng(24.607069137709683,-131.66015625)),Y=function(e){var t=e.id,n=e.layerConfig,i=e.interactivity,r=(n.period||{}).value||"1971",o="https://api.resourcewatch.org/v1/layer/"+t+"/tile/loca/{z}/{x}/{y}?year="+new Date(r).toISOString(),a=H.tileLayer(o,y({},n.body,{minNativeZoom:4,bounds:X}));if(i){var s=new R,u=H.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});a=new u([a,s])}return new Promise(function(e){e(a)})},K=("undefined"!=typeof window?window:{}).L,Q=function(e){var t=e.id,n=e.layerConfig,i=e.interactivity,r=(n.period||{}).value||"1971-01-01",o="https://api.resourcewatch.org/v1/layer/"+t+"/tile/nexgddp/{z}/{x}/{y}?year="+new Date(r).toISOString(),a=K.tileLayer(o,n.body);if(i){var s=new R,u=K.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});a=new u([a,s])}return new Promise(function(e){e(a)})},t=function(){function t(e){var r=this;a(this,t),this.events={},this.method={cartodb:p,carto:p,raster:p,arcgis:U,featureservice:U,mapservice:U,tileservice:U,esrifeatureservice:U,esrimapservice:U,esritileservice:U,gee:W,loca:Y,nexgddp:Q,leaflet:B,wms:B},this.setEvents=function(e){var n=e.mapLayer,i=e.events;return"cluster"!==e.layerConfig.type&&(r.events[e.id]&&Object.keys(r.events[e.id]).forEach(function(t){n.group?n.eachLayer(function(e){e.off(t)}):n.off(t)}),Object.keys(i).forEach(function(t){n.group?n.eachLayer(function(e){e.on(t,i[t])}):n.on(t,i[t])}),r.events[e.id]=i),r},this.fitMapToLayer=function(e){var t=e.get("mapLayerBounds");t&&r.map.fitBounds(t)},this.map=e}return e(t,[{key:"add",value:function(e){var t=e.mapLayer;this.map.addLayer(t)}},{key:"remove",value:function(e){var n=e.mapLayer,t=e.events;t&&n&&Object.keys(t).forEach(function(t){n.group?n.eachLayer(function(e){e.off(t)}):n.off(t)}),n&&this.map.removeLayer(n)}},{key:"getLayerByProvider",value:function(e){return this.method[e]}},{key:"getLayerBoundsByProvider",value:function(e){return this.method[e].getBounds}},{key:"setZIndex",value:function(e,t){return e.mapLayer.setZIndex(t),this}},{key:"setOpacity",value:function(e,t){var n=e.mapLayer;return"function"==typeof n.setOpacity&&n.setOpacity(t),"function"==typeof n.setStyle&&n.setStyle({opacity:t}),this}},{key:"setVisibility",value:function(e,t){var n=e.opacity;this.setOpacity(e,t?n:0)}},{key:"setParams",value:function(e){this.remove(e)}},{key:"setLayerConfig",value:function(e){this.remove(e)}},{key:"setDecodeParams",value:function(e){var t=e.mapLayer,n=e.params,i=e.sqlParams,r=e.decodeParams,o=e.decodeFunction;return t.reDraw({decodeParams:r,decodeFunction:o,params:n,sqlParams:i}),this}}]),t}(),$=function(o){return function(r){return c(r).then(function(e){var t=r.layerConfig,n=e.cdn_url.templates.https.url+"/"+t.account+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png",i=new o.UrlTemplateImageryProvider({url:n});return i.errorEvent.addEventListener(function(){return!1}),new o.ImageryLayer(i)})}},ee=function(){function n(e){a(this,n),te.call(this);var o,t=n.Cesium;this.map=e,this.eventListener=new t.ScreenSpaceEventHandler(e.scene.canvas),this.method={carto:$(t),cartodb:$(t),cesium:(o=t,function(r){return new Promise(function(e){var t=r.layerConfig,n=(void 0===t?{}:t).body.url,i=new o.UrlTemplateImageryProvider({url:n});i.errorEvent.addEventListener(function(){return!1}),e(new o.ImageryLayer(i))})})}}return e(n,[{key:"add",value:function(e){var t=e.mapLayer;this.map.imageryLayers.add(t)}},{key:"remove",value:function(e){var t=e.mapLayer;this.map.imageryLayers.remove(t,!0),this.eventListener.destroy()}},{key:"getLayerByProvider",value:function(e){return this.method[e]}},{key:"setZIndex",value:function(e,t){var n=this.map.imageryLayers.length,i=e.mapLayer,r=t<0?0:n<=t?n-1:t,o=this.map.imageryLayers.indexOf(i);if(o!==r)for(var a=r-o,s=0;s<Math.abs(a);s++)0<a?this.map.imageryLayers.raise(i):this.map.imageryLayers.lower(i);return this}},{key:"setOpacity",value:function(e,t){return e.mapLayer.alpha=t,this}},{key:"setVisibility",value:function(e,t){return e.mapLayer.show=t,this}},{key:"setEvents",value:function(e){var n=this,i=e.events;return Object.keys(i).forEach(function(e){var t=i[e];n.eventListener.getInputAction(e)&&n.eventListener.removeInputAction(e),n.eventListener.setInputAction(n.getCoordinatesFromEvent(t),e)}),this}},{key:"setParams",value:function(e){this.remove(e)}},{key:"setLayerConfig",value:function(e){this.remove(e)}},{key:"setDecodeParams",value:function(e){console.info("Decode params callback",e,this)}}]),n}();ee.Cesium="undefined"!=typeof window?window.Cesium:null;var te=function(){var l=this;this.getCoordinatesFromEvent=function(c){return function(e){var t=e.position,n=ee.Cesium,i=new n.Cartesian2(t.x,t.y),r=l.map.scene.globe.ellipsoid,o=l.map.camera.pickEllipsoid(i,r);if(o){var a=r.cartesianToCartographic(o),s=n.Math.toDegrees(a.latitude),u=n.Math.toDegrees(a.longitude);c(e,{lat:s,lng:u})}}}},ne=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};a(this,t),this.opacity=1,this.visibility=!0,Object.assign(this,e,{changedAttributes:{}})}return e(t,[{key:"get",value:function(e){return this[e]}},{key:"set",value:function(e,t){return this[e]=t,this}},{key:"update",value:function(e){var t=this,n=y({},this),i=y({},e);this.set("changedAttributes",{}),Object.keys(i).forEach(function(e){r(n[e],i[e])||(t.changedAttributes[e]=i[e],t.set(e,i[e]))})}}]),t}();var ie=function(){function r(e,t){var n,i=this;a(this,r),this.fitMapToLayer=function(t){if("function"==typeof i.plugin.fitMapToLayer){var e=i.layers.find(function(e){return e.id===t});e&&i.plugin.fitMapToLayer(e)}else console.error("This plugin does not support fitting map bounds to layer yet.")},this.map=e,this.plugin=new t(this.map),(n=this.plugin)&&["add","remove","setVisibility","setOpacity","setEvents","setZIndex","setLayerConfig","setParams","setDecodeParams","getLayerByProvider"].forEach(function(e){n[e]||console.error("The "+e+" function is required for layer manager plugins")}),this.layers=[],this.promises={}}return e(r,[{key:"renderLayers",value:function(){var s=this;return 0<this.layers.length?(this.layers.forEach(function(e){var t=e.changedAttributes,n=t.sqlParams,i=t.params,r=t.layerConfig,o=0<Object.keys(t).length,a=n||i||r;if(!a){if(e.mapLayer&&!o)return!1;if(e.mapLayer&&o)return s.updateLayer(e)}return e.mapLayer&&a&&s.updateLayer(e),s.requestLayer(e),s.requestLayerBounds(e),e.set("changedAttributes",{})}),0===Object.keys(this.promises).length?Promise.resolve(this.layers):Promise.all(Object.values(this.promises)).then(function(){return s.layers}).then(function(){s.promises={}})):Promise.resolve(this.layers)}},{key:"add",value:function(e){var i=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{opacity:1,visibility:!0,zIndex:0,interactivity:null};return void 0===e?(console.error("layers is required"),this):Array.isArray(e)?(e.forEach(function(t){var e=i.layers.find(function(e){return e.id===t.id}),n=y({},t,r);e?e.update(n):i.layers.push(new ne(n))}),this.layers):(console.error("layers should be an array"),this)}},{key:"updateLayer",value:function(e){var t=e.changedAttributes,n=t.opacity,i=t.visibility,r=t.zIndex,o=t.params,a=t.sqlParams,s=t.decodeParams,u=t.layerConfig,c=t.events;void 0!==n&&this.plugin.setOpacity(e,n),void 0!==i&&this.plugin.setOpacity(e,i?e.opacity:0),void 0!==r&&this.plugin.setZIndex(e,r),void 0!==c&&this.setEvents(e),l(u)||this.plugin.setLayerConfig(e),l(o)||this.plugin.setParams(e),l(a)||this.plugin.setParams(e),l(s)||this.plugin.setDecodeParams(e)}},{key:"remove",value:function(e){var n=this,i=this.layers.slice(0),r=Array.isArray(e)?e:[e];this.layers.forEach(function(e,t){r?r.includes(e.id)&&(n.plugin.remove(e),i.splice(t,1)):n.plugin.remove(e)}),this.layers=r?i:[]}},{key:"setOpacity",value:function(t,n){var i=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){i.plugin.setOpacity(e,n)}):console.error("Can't find the layer")}},{key:"setVisibility",value:function(t,n){var i=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){i.plugin.setVisibility(e,n)}):console.error("Can't find the layer")}},{key:"setZIndex",value:function(t,n){var i=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){i.plugin.setZIndex(e,n)}):console.error("Can't find the layer")}},{key:"setEvents",value:function(e){e.events&&this.plugin.setEvents(e)}},{key:"requestLayer",value:function(t){var n=this,e=t.provider,i=this.plugin.getLayerByProvider(e);return i?(this.promises[t.id]&&this.promises[t.id].isPending&&this.promises[t.id].isPending()&&this.promises[t.id].cancel(),this.promises[t.id]=i.call(this,t).then(function(e){t.set("mapLayer",e),n.plugin.add(t),n.plugin.setZIndex(t,t.zIndex),n.plugin.setOpacity(t,t.opacity),n.plugin.setVisibility(t,t.visibility),n.setEvents(t)}),this):(this.promises[t.id]=Promise.reject(new Error(e+" provider is not yet supported.")),!1)}},{key:"requestLayerBounds",value:function(t){var e=t.provider,n=this.plugin.getLayerBoundsByProvider(e),i=t.id+"_bounds";return!!n&&(this.promises[i]&&this.promises[i].isPending&&this.promises[i].isPending()&&this.promises[i].cancel(),this.promises[i]=n.call(this,t).then(function(e){t.set("mapLayerBounds",e)}),this)}}]),r}();return ie.PluginLeaflet=t,ie.PluginCesium=ee,ie.replace=m,ie.substitution=s,ie.concatenation=u,ie});
