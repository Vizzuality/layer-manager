!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("axios"),require("lodash/compact"),require("lodash/isEqual"),require("lodash/isEmpty")):"function"==typeof define&&define.amd?define(["axios","lodash/compact","lodash/isEqual","lodash/isEmpty"],t):e.LayerManager=t(e.axios,e.compact,e.isEqual,e.isEmpty)}(this,function(d,o,r,l){"use strict";var i="default"in d?d.default:d;o=o&&o.hasOwnProperty("default")?o.default:o,r=r&&r.hasOwnProperty("default")?r.default:r,l=l&&l.hasOwnProperty("default")?l.default:l;var a=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),y=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},n={"Content-Type":"application/json"},f=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return i.get(e,y({headers:n},t))},s=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=e;return Object.keys(t).forEach(function(e){i=i.replace(new RegExp("{{"+e+"}}","g"),t[e]).replace(new RegExp("{"+e+"}","g"),t[e])}),i},u=function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},t=e,r=void 0;return Object.keys(n).forEach(function(i){r=(r=""+o(Object.keys(n[i]).map(function(e){var t=n[i][e];return Array.isArray(t)&&t.length?e+" IN ("+t.map(function(e){return"number"!=typeof e?"'"+e+"'":e}).join(", ")+")":!Array.isArray(t)&&t?"number"!=typeof t?e+" = '"+t+"'":e+" = "+t:null})).join(" AND "))&&i.startsWith("where")?"WHERE "+r:r&&i.startsWith("and")?"AND "+r:"",t=(t=t.replace(new RegExp("{{"+i+"}}","g"),r)).replace(new RegExp("{"+i+"}","g"),r)}),t},v=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=e;return"string"==typeof n&&(n=s(n,t),n=u(n,i)),n},c=function(e){var t=e.layerConfig,i=e.params,n=e.sqlParams,r=e.interactivity,o=!1===t.parse?t:JSON.parse(v(JSON.stringify(t),i,n)),a=JSON.stringify({version:"1.3.0",stat_tag:"API",layers:o.body.layers.map(function(e){return r&&r.length?y({},e,{options:y({},e.options,{interactivity:r.split(", ")})}):e})}),s="?stat_tag=API&config="+encodeURIComponent(a),u="https://"+o.account+"-cdn.resilienceatlas.org/user/ra/api/v1/map"+s,c=e.layerRequest;c&&c.cancel("Operation canceled by the user.");var l=d.CancelToken.source();return e.set("layerRequest",l),f(u,{cancelToken:l.token}).then(function(e){return 400<e.status?(console.error(e),!1):e.data})},h=("undefined"!=typeof window?window:{}).L,p=function(e){if(!h)throw new Error("Leaflet must be defined.");var t=e.layerConfig,i=e.params,n=e.sqlParams;e.interactivity,!1===t.parse||JSON.parse(v(JSON.stringify(t),i,n));return new Promise(function(n,t){c(e).then(function(e){var t="https://"+e.cdn_url.https+"/ra/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png",i=h.tileLayer(t);return n(i)}).catch(function(e){return t(e)})})},m=("undefined"!=typeof window?window:{}).L,g=m&&m.GridLayer.extend({tiles:{},createTile:function(e,t){for(var i=this,n=e.x,r=e.y,o=e.z,a=this.options.params,s=v(a.url,y({x:n,y:r,z:o},a)),u=Object.keys(this.tiles),c=0;c<u.length;c++)this.tiles[u[c]].z!==o&&delete this.tiles[u[c]];this.done=t;var l=m.DomUtil.create("canvas","leaflet-tile"),h=l.getContext("2d"),p=this.getTileSize();return l.width=p.x,l.height=p.y,this.getTile({x:n,y:r,z:o}).then(function(e){i.cacheTile(y({id:s,tile:l,ctx:h,image:e},{x:n,y:r,z:o})),i.drawCanvas(s),t(null,l)}).catch(function(e){t(e,l)}),l},getTile:function(e){var t=this,i=e.x,n=e.y,r=e.z,o=this.options,a=o.params,s=o.sqlParams,u=a.url,c=a.dataMaxZoom,l=void 0===c?20:c,h=r-l,p=v(a.url,y({x:i,y:n,z:r},a)),d={x:i,y:n,z:r};0<h&&(d={x:Math.floor(i/Math.pow(2,h)),y:Math.floor(n/Math.pow(2,h)),z:l});var f=v(u,y({},d,a),s);return new Promise(function(r,o){t.tiles[p]&&r(t.tiles[p].image);var e=new XMLHttpRequest;e.addEventListener("load",function(e){var t=e.currentTarget.response,i=URL.createObjectURL(t),n=new Image;n.src=i,n.onload=function(){n.crossOrigin="",r(n),URL.revokeObjectURL(i)},n.onerror=function(){o(new Error("Can't load image"))}}),e.addEventListener("error",o),e.open("GET",f,!0),e.responseType="blob",e.send()})},cacheTile:function(e){this.tiles[e.id]=y({},this.tiles[e.id],e)},drawCanvas:function(e){"use asm";if(!this.tiles[e]){return}var t=this.tiles[e],i=t.tile,n=t.ctx,r=t.image,o=t.x,a=t.y,s=t.z;if(!i||!n||!r||typeof o==="undefined"||typeof a==="undefined"||typeof s==="undefined"){delete this.tiles[e];return}var u=this.options,c=u.params,l=u.decodeParams,h=u.decodeFunction;var p=c.dataMaxZoom,d=p===undefined?20:p;var f=s-d;n.clearRect(0,0,i.width,i.width);if(f<0){n.drawImage(r,0,0)}else{n.imageSmoothingEnabled=false;n.mozImageSmoothingEnabled=false;var y=i.width/Math.pow(2,f)*(o%Math.pow(2,f))||0;var v=i.height/Math.pow(2,f)*(a%Math.pow(2,f))||0;var m=i.width/Math.pow(2,f)||0;var g=i.height/Math.pow(2,f)||0;n.drawImage(r,y,v,m,g,0,0,i.width,i.height)}var w=n.getImageData(0,0,i.width,i.height);if(typeof h==="function"){h(w.data,i.width,i.height,s,l)}n.putImageData(w,0,0)},reDraw:function(e){var a=this;this.options.params=e.params,this.options.sqlParams=e.sqlParams,this.options.decodeParams=e.decodeParams;var s=e.params,u=e.sqlParams;s&&s.url&&Object.keys(this.tiles).map(function(e){var t=a.tiles[e],i=t.x,n=t.y,r=t.z,o=v(s.url,y({x:i,y:n,z:r},s,{sqlParams:u}));return a.drawCanvas(o)})}});function w(e,t,i,n,r,o){if(!(r-n<=i)){var a=Math.floor((n+r)/2);!function e(t,i,n,r,o,a){for(;r<o;){if(600<o-r){var s=o-r+1,u=n-r+1,c=Math.log(s),l=.5*Math.exp(2*c/3),h=.5*Math.sqrt(c*l*(s-l)/s)*(u-s/2<0?-1:1),p=Math.max(r,Math.floor(n-u*l/s+h)),d=Math.min(o,Math.floor(n+(s-u)*l/s+h));e(t,i,n,p,d,a)}var f=i[2*n+a],y=r,v=o;for(L(t,i,r,n),i[2*o+a]>f&&L(t,i,r,o);y<v;){for(L(t,i,y,v),y++,v--;i[2*y+a]<f;)y++;for(;i[2*v+a]>f;)v--}i[2*r+a]===f?L(t,i,r,v):L(t,i,++v,o),v<=n&&(r=v+1),n<=v&&(o=v-1)}}(e,t,a,n,r,o%2),w(e,t,i,n,a-1,o+1),w(e,t,i,a+1,r,o+1)}}function L(e,t,i,n){b(e,i,n),b(t,2*i,2*n),b(t,2*i+1,2*n+1)}function b(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function x(e,t,i,n){var r=e-i,o=t-n;return r*r+o*o}function O(e,t,i,n,r){return new P(e,t,i,n,r)}function P(e,t,i,n,r){t=t||E,i=i||k,r=r||Array,this.nodeSize=n||64,this.points=e,this.ids=new r(e.length),this.coords=new r(2*e.length);for(var o=0;o<e.length;o++)this.ids[o]=o,this.coords[2*o]=t(e[o]),this.coords[2*o+1]=i(e[o]);w(this.ids,this.coords,this.nodeSize,0,this.ids.length-1,0)}function E(e){return e[0]}function k(e){return e[1]}function C(e){this.options=S(Object.create(this.options),e),this.trees=new Array(this.options.maxZoom+1)}function M(e){return{type:"Feature",id:e.id,properties:I(e),geometry:{type:"Point",coordinates:[(n=e.x,360*(n-.5)),(t=e.y,i=(180-360*t)*Math.PI/180,360*Math.atan(Math.exp(i))/Math.PI-90)]}};var t,i,n}function I(e){var t=e.numPoints,i=1e4<=t?Math.round(t/1e3)+"k":1e3<=t?Math.round(t/100)/10+"k":t;return S(S({},e.properties),{cluster:!0,cluster_id:e.id,point_count:t,point_count_abbreviated:i})}function z(e){return e/360+.5}function _(e){var t=Math.sin(e*Math.PI/180),i=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return i<0?0:1<i?1:i}function S(e,t){for(var i in t)e[i]=t[i];return e}function j(e){return e.x}function Z(e){return e.y}C.prototype={options:{minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!(P.prototype={range:function(e,t,i,n){return function(e,t,i,n,r,o,a){for(var s,u,c=[0,e.length-1,0],l=[];c.length;){var h=c.pop(),p=c.pop(),d=c.pop();if(p-d<=a)for(var f=d;f<=p;f++)s=t[2*f],u=t[2*f+1],i<=s&&s<=r&&n<=u&&u<=o&&l.push(e[f]);else{var y=Math.floor((d+p)/2);s=t[2*y],u=t[2*y+1],i<=s&&s<=r&&n<=u&&u<=o&&l.push(e[y]);var v=(h+1)%2;(0===h?i<=s:n<=u)&&(c.push(d),c.push(y-1),c.push(v)),(0===h?s<=r:u<=o)&&(c.push(y+1),c.push(p),c.push(v))}}return l}(this.ids,this.coords,e,t,i,n,this.nodeSize)},within:function(e,t,i){return function(e,t,i,n,r,o){for(var a=[0,e.length-1,0],s=[],u=r*r;a.length;){var c=a.pop(),l=a.pop(),h=a.pop();if(l-h<=o)for(var p=h;p<=l;p++)x(t[2*p],t[2*p+1],i,n)<=u&&s.push(e[p]);else{var d=Math.floor((h+l)/2),f=t[2*d],y=t[2*d+1];x(f,y,i,n)<=u&&s.push(e[d]);var v=(c+1)%2;(0===c?i-r<=f:n-r<=y)&&(a.push(h),a.push(d-1),a.push(v)),(0===c?f<=i+r:y<=n+r)&&(a.push(d+1),a.push(l),a.push(v))}}return s}(this.ids,this.coords,e,t,i,this.nodeSize)}}),reduce:null,initial:function(){return{}},map:function(e){return e}},load:function(e){var t=this.options.log;t&&console.time("total time");var i="prepare "+e.length+" points";t&&console.time(i),this.points=e;for(var n,r,o,a=[],s=0;s<e.length;s++)e[s].geometry&&a.push((n=e[s],r=s,void 0,{x:z((o=n.geometry.coordinates)[0]),y:_(o[1]),zoom:1/0,index:r,parentId:-1}));this.trees[this.options.maxZoom+1]=O(a,j,Z,this.options.nodeSize,Float32Array),t&&console.timeEnd(i);for(var u=this.options.maxZoom;u>=this.options.minZoom;u--){var c=+Date.now();a=this._cluster(a,u),this.trees[u]=O(a,j,Z,this.options.nodeSize,Float32Array),t&&console.log("z%d: %d clusters in %dms",u,a.length,+Date.now()-c)}return t&&console.timeEnd("total time"),this},getClusters:function(e,t){var i=((e[0]+180)%360+360)%360-180,n=Math.max(-90,Math.min(90,e[1])),r=180===e[2]?180:((e[2]+180)%360+360)%360-180,o=Math.max(-90,Math.min(90,e[3]));if(360<=e[2]-e[0])i=-180,r=180;else if(r<i){var a=this.getClusters([i,n,180,o],t),s=this.getClusters([-180,n,r,o],t);return a.concat(s)}for(var u=this.trees[this._limitZoom(t)],c=u.range(z(i),_(o),z(r),_(n)),l=[],h=0;h<c.length;h++){var p=u.points[c[h]];l.push(p.numPoints?M(p):this.points[p.index])}return l},getChildren:function(e){var t=e>>5,i=e%32,n="No cluster with the specified id.",r=this.trees[i];if(!r)throw new Error(n);var o=r.points[t];if(!o)throw new Error(n);for(var a=this.options.radius/(this.options.extent*Math.pow(2,i-1)),s=r.within(o.x,o.y,a),u=[],c=0;c<s.length;c++){var l=r.points[s[c]];l.parentId===e&&u.push(l.numPoints?M(l):this.points[l.index])}if(0===u.length)throw new Error(n);return u},getLeaves:function(e,t,i){t=t||10,i=i||0;var n=[];return this._appendLeaves(n,e,t,i,0),n},getTile:function(e,t,i){var n=this.trees[this._limitZoom(e)],r=Math.pow(2,e),o=this.options.extent,a=this.options.radius/o,s=(i-a)/r,u=(i+1+a)/r,c={features:[]};return this._addTileFeatures(n.range((t-a)/r,s,(t+1+a)/r,u),n.points,t,i,r,c),0===t&&this._addTileFeatures(n.range(1-a/r,s,1,u),n.points,r,i,r,c),t===r-1&&this._addTileFeatures(n.range(0,s,a/r,u),n.points,-1,i,r,c),c.features.length?c:null},getClusterExpansionZoom:function(e){for(var t=e%32-1;t<this.options.maxZoom;){var i=this.getChildren(e);if(t++,1!==i.length)break;e=i[0].properties.cluster_id}return t},_appendLeaves:function(e,t,i,n,r){for(var o=this.getChildren(t),a=0;a<o.length;a++){var s=o[a].properties;if(s&&s.cluster?r+s.point_count<=n?r+=s.point_count:r=this._appendLeaves(e,s.cluster_id,i,n,r):r<n?r++:e.push(o[a]),e.length===i)break}return r},_addTileFeatures:function(e,t,i,n,r,o){for(var a=0;a<e.length;a++){var s=t[e[a]],u={type:1,geometry:[[Math.round(this.options.extent*(s.x*r-i)),Math.round(this.options.extent*(s.y*r-n))]],tags:s.numPoints?I(s):this.points[s.index].properties},c=s.numPoints?s.id:this.points[s.index].id;void 0!==c&&(u.id=c),o.features.push(u)}},_limitZoom:function(e){return Math.max(this.options.minZoom,Math.min(e,this.options.maxZoom+1))},_cluster:function(e,t){for(var i=[],n=this.options.radius/(this.options.extent*Math.pow(2,t)),r=0;r<e.length;r++){var o=e[r];if(!(o.zoom<=t)){o.zoom=t;var a=this.trees[t+1],s=a.within(o.x,o.y,n),u=o.numPoints||1,c=o.x*u,l=o.y*u,h=null;this.options.reduce&&(h=this.options.initial(),this._accumulate(h,o));for(var p=(r<<5)+(t+1),d=0;d<s.length;d++){var f=a.points[s[d]];if(!(f.zoom<=t)){f.zoom=t;var y=f.numPoints||1;c+=f.x*y,l+=f.y*y,u+=y,f.parentId=p,this.options.reduce&&this._accumulate(h,f)}}1===u?i.push(o):(o.parentId=p,i.push({x:c/u,y:l/u,zoom:1/0,id:p,parentId:-1,numPoints:u,properties:h}))}}return i},_accumulate:function(e,t){var i=t.numPoints?t.properties:this.options.map(this.points[t.index].properties);this.options.reduce(e,i)}};var q=("undefined"!=typeof window?window:{}).L,A={50:25,100:30,1e3:40},T=q&&q.GeoJSON.extend({initialize:function(e){var i=this,t=this;q.GeoJSON.prototype.initialize.call(this,[]);var n=e.layerConfig,a=e.events,r=e.decodeClusters;if(r){var o=e.layerConfig||{},s=o.html,u=o.sizes,c=void 0===u?A:u,l=o.clusterIcon,h=o.icon;q.Util.setOptions(this,{pointToLayer:function(e,t){if(!(e.properties&&e.properties.cluster))return q.marker(t,{icon:q.icon(y({iconSize:[35,35]},h))});var i=e.properties.point_count,n=null;if("function"==typeof c)n=function(){return c(i)};else{var r=Object.keys(c).find(function(e){return i<=parseInt(e,10)}),o=c[r];n=q.point(o,o)}return q.marker(t,{icon:q.divIcon(y({iconSize:n,html:s&&"function"==typeof s?s(e):'<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; '+(l.color?"background-color: "+l.color+";":"")+'">'+e.properties.point_count_abbreviated+"</div>"},l))})},onEachFeature:function(o,e){o.properties&&o.properties.cluster?e.on({click:function(){return t.setMapView(o)}}):a&&e.on(Object.keys(a).reduce(function(e,t){return y({},e,(r=function(e){return a[t](y({},e,{data:o.properties}))},(n=t)in(i={})?Object.defineProperty(i,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):i[n]=r,i));var i,n,r},{}))}});var p=(n||{}).clusterConfig;this.supercluster=new C(y({radius:80,maxZoom:16},p)),function(e){var t=e.layerConfig,i=e.layerRequest,n=t.body.url;i&&i.cancel("Operation canceled by the user.");var r=d.CancelToken.source();return e.set("layerRequest",r),f(n,{cancelToken:r.token}).then(function(e){return 400<e.status?(console.error(e),!1):e.data})}(e).then(function(e){var t=r(e);i.supercluster.load(t),i.update()})}else console.warn("You must provide a decodeClusters function")},setMapView:function(e){var t=e.geometry.coordinates,i=this.supercluster.getClusterExpansionZoom(e.properties.cluster_id);this._map.setView(t.reverse(),i)},onAdd:function(e){q.GeoJSON.prototype.onAdd.call(this,e),e.on("moveend zoomend",this.onMove,this)},onRemove:function(e){e.off("moveend zoomend",this.onMove,this),this.clear()},onMove:function(){this.clear(),this.update()},update:function(){var e=this._map.getZoom(),t=this._map.getBounds(),i=[t._southWest.lng,t._southWest.lat,t._northEast.lng,t._northEast.lat],n=this.supercluster.getClusters(i,e);this.addData(n)},clear:function(){q.GeoJSON.prototype.clearLayers.call(this,[])}}),N=("undefined"!=typeof window?window:{}).L,R=N&&N.GridLayer.extend({tiles:{},cache:{},mouseOn:null,createTile:function(e){for(var t=e.z,i=Object.keys(this.tiles),n=0;n<i.length;n++)this.tiles[i[n]].z!==t&&delete this.tiles[i[n]];var r=N.DomUtil.create("div","leaflet-tile"),o=this.getTileSize();return r.width=o.x,r.height=o.y,r},onAdd:function(e){N.GridLayer.prototype.onAdd.call(this,e),this.map=e;var t=Math.round(this.map.getZoom());t>this.options.maxZoom||t<this.options.minZoom||(e.on("click",this.click,this),e.on("mousemove",this.move,this))},onRemove:function(){var e=this.map;e.off("click",this.click,this),e.off("mousemove",this.move,this)},click:function(e){this.fire("click",this.objectForEvent(e))},move:function(e){var t=this.objectForEvent(e);t.data!==this.mouseOn?(this.mouseOn&&this.fire("mouseout",{latlng:e.latlng,data:this.mouseOn}),t.data&&this.fire("mouseover",t),this.mouseOn=t.data):t.data&&this.fire("mousemove",t)},objectForEvent:function(e){return N.extend({latlng:e.latlng,data:null},e)}}),D=("undefined"!=typeof window?window:{}).L,J=eval,F=function(e){if(!D)throw new Error("Leaflet must be defined.");var t=e.layerConfig,i=e.params,n=e.sqlParams,r=e.decodeParams,o=e.interactivity,a=void 0,s=!1===t.parse?t:JSON.parse(v(JSON.stringify(t),i,n));switch(s.body.crs&&D.CRS[s.body.crs]&&(s.body.crs=D.CRS[s.body.crs.replace(":","")],s.body.pane="tilePane"),s.type){case"wms":a=D.tileLayer.wms(s.url||s.body.url,s.body);break;case"tileLayer":if(0<=JSON.stringify(s.body).indexOf('style: "function')&&(s.body.style=J("("+s.body.style+")")),a=r&&s.canvas?new g(y({},e)):D.tileLayer(s.url||s.body.url,s.body),o){var u=new R,c=D.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});a=new c([a,u])}break;case"cluster":0<=JSON.stringify(s.body).indexOf('style: "function')&&(s.body.style=J("("+s.body.style+")")),a=new T(e);break;default:a=D[s.type](s.body,s.options||{})}return new Promise(function(e,t){a?e(a):t(new Error('"type" specified in layer spec doesn`t exist'))})},G=("undefined"!=typeof window?window:{}).L,U=eval,V=function(a){if(!G)throw new Error("Leaflet must be defined.");if(!G.esri)throw new Error("To support this layer you should add esri library for Leaflet.");var e=a.layerConfig,s=a.interactivity,t=a.params,i=a.sqlParams,u=!1===e.parse?e:JSON.parse(v(JSON.stringify(e),t,i)),c=JSON.stringify(u.body||{}).replace(/"mosaic-rule":/g,'"mosaicRule":').replace(/"mosaic_rule":/g,'"mosaicRule":').replace(/"use-cors":/g,'"useCors":').replace(/"use_cors":/g,'"useCors":');return G[u.type]?new F(y({},a)):new Promise(function(e,t){if(!G.esri[u.type])return t(new Error('"type" specified in layer spec doesn`t exist'));var i=JSON.parse(c);i.pane="tilePane",i.useCors=!0,i.style&&0<=i.style.indexOf("function")&&(i.style=U("("+i.style+")"));var n=void 0;if(!(n=G.esri[u.type](i)))return t();if(n.on("load",function(){n.setZIndex(a.zIndex)}),n.on("requesterror",function(e){return console.error(e)}),n.setZIndex||(n.setZIndex=function(e){n._currentImage&&(n._currentImage._image.style.zIndex=e)}),s){var r=new R,o=G.LayerGroup.extend({group:!0,setOpacity:function(t){a.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});n=new o([n,r])}return e(n)})},B=("undefined"!=typeof window?window:{}).L,W=function(e){if(!B)throw new Error("Leaflet must be defined.");var t=e.id,i=e.layerConfig,n=e.interactivity,r=e.params,o=e.sqlParams,a=e.decodeParams,s="https://api.resourcewatch.org/v1/layer/"+t+"/tile/gee/{z}/{x}/{y}",u=!1===i.parse?i:JSON.parse(v(JSON.stringify(i),r,o)),c=void 0;switch(u.type){case"tileLayer":c=a?new g(y({},e)):B.tileLayer(s,u.body);break;default:c=B.tileLayer(s,u.body)}if(n){var l=new R,h=B.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});c=new h([c,l])}return new Promise(function(e,t){c?e(c):t(new Error('"type" specified in layer spec doesn`t exist'))})},H=("undefined"!=typeof window?window:{}).L,X=H&&new H.LatLngBounds(new H.LatLng(49.496674527470454,-66.357421875),new H.LatLng(24.607069137709683,-131.66015625)),Y=function(e){var t=e.id,i=e.layerConfig,n=e.interactivity,r=(i.period||{}).value||"1971",o="https://api.resourcewatch.org/v1/layer/"+t+"/tile/loca/{z}/{x}/{y}?year="+new Date(r).toISOString(),a=H.tileLayer(o,y({},i.body,{minNativeZoom:4,bounds:X}));if(n){var s=new R,u=H.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});a=new u([a,s])}return new Promise(function(e){e(a)})},K=("undefined"!=typeof window?window:{}).L,Q=function(e){var t=e.id,i=e.layerConfig,n=e.interactivity,r=(i.period||{}).value||"1971-01-01",o="https://api.resourcewatch.org/v1/layer/"+t+"/tile/nexgddp/{z}/{x}/{y}?year="+new Date(r).toISOString(),a=K.tileLayer(o,i.body);if(n){var s=new R,u=K.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});a=new u([a,s])}return new Promise(function(e){e(a)})},t=function(){function i(e){var t=this;a(this,i),this.events={},this.method={cartodb:p,carto:p,raster:p,arcgis:V,featureservice:V,mapservice:V,tileservice:V,esrifeatureservice:V,esrimapservice:V,esritileservice:V,gee:W,loca:Y,nexgddp:Q,leaflet:F,wms:F},this.setEvents=function(e){var i=e.mapLayer,n=e.events;return"cluster"!==e.layerConfig.type&&(t.events[e.id]&&Object.keys(t.events[e.id]).forEach(function(t){i.group?i.eachLayer(function(e){e.off(t)}):i.off(t)}),Object.keys(n).forEach(function(t){i.group?i.eachLayer(function(e){e.on(t,n[t])}):i.on(t,n[t])}),t.events[e.id]=n),t},this.map=e}return e(i,[{key:"add",value:function(e){var t=e.mapLayer;this.map.addLayer(t)}},{key:"remove",value:function(e){var i=e.mapLayer,t=e.events;t&&i&&Object.keys(t).forEach(function(t){i.group?i.eachLayer(function(e){e.off(t)}):i.off(t)}),i&&this.map.removeLayer(i)}},{key:"getLayerByProvider",value:function(e){return this.method[e]}},{key:"setZIndex",value:function(e,t){return e.mapLayer.setZIndex(t),this}},{key:"setOpacity",value:function(e,t){var i=e.mapLayer;return"function"==typeof i.setOpacity&&i.setOpacity(t),"function"==typeof i.setStyle&&i.setStyle({opacity:t}),this}},{key:"setVisibility",value:function(e,t){var i=e.opacity;this.setOpacity(e,t?i:0)}},{key:"setParams",value:function(e){this.remove(e)}},{key:"setLayerConfig",value:function(e){this.remove(e)}},{key:"setDecodeParams",value:function(e){var t=e.mapLayer,i=e.params,n=e.sqlParams,r=e.decodeParams,o=e.decodeFunction;return t.reDraw({decodeParams:r,decodeFunction:o,params:i,sqlParams:n}),this}}]),i}(),$=function(o){return function(r){return c(r).then(function(e){var t=r.layerConfig,i=e.cdn_url.templates.https.url+"/"+t.account+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png",n=new o.UrlTemplateImageryProvider({url:i});return n.errorEvent.addEventListener(function(){return!1}),new o.ImageryLayer(n)})}},ee=function(){function i(e){a(this,i),te.call(this);var o,t=i.Cesium;this.map=e,this.eventListener=new t.ScreenSpaceEventHandler(e.scene.canvas),this.method={carto:$(t),cartodb:$(t),cesium:(o=t,function(r){return new Promise(function(e){var t=r.layerConfig,i=(void 0===t?{}:t).body.url,n=new o.UrlTemplateImageryProvider({url:i});n.errorEvent.addEventListener(function(){return!1}),e(new o.ImageryLayer(n))})})}}return e(i,[{key:"add",value:function(e){var t=e.mapLayer;this.map.imageryLayers.add(t)}},{key:"remove",value:function(e){var t=e.mapLayer;this.map.imageryLayers.remove(t,!0),this.eventListener.destroy()}},{key:"getLayerByProvider",value:function(e){return this.method[e]}},{key:"setZIndex",value:function(e,t){var i=this.map.imageryLayers.length,n=e.mapLayer,r=t<0?0:i<=t?i-1:t,o=this.map.imageryLayers.indexOf(n);if(o!==r)for(var a=r-o,s=0;s<Math.abs(a);s++)0<a?this.map.imageryLayers.raise(n):this.map.imageryLayers.lower(n);return this}},{key:"setOpacity",value:function(e,t){return e.mapLayer.alpha=t,this}},{key:"setVisibility",value:function(e,t){return e.mapLayer.show=t,this}},{key:"setEvents",value:function(e){var i=this,n=e.events;return Object.keys(n).forEach(function(e){var t=n[e];i.eventListener.getInputAction(e)&&i.eventListener.removeInputAction(e),i.eventListener.setInputAction(i.getCoordinatesFromEvent(t),e)}),this}},{key:"setParams",value:function(e){this.remove(e)}},{key:"setLayerConfig",value:function(e){this.remove(e)}},{key:"setDecodeParams",value:function(e){console.info("Decode params callback",e,this)}}]),i}();ee.Cesium="undefined"!=typeof window?window.Cesium:null;var te=function(){var l=this;this.getCoordinatesFromEvent=function(c){return function(e){var t=e.position,i=ee.Cesium,n=new i.Cartesian2(t.x,t.y),r=l.map.scene.globe.ellipsoid,o=l.map.camera.pickEllipsoid(n,r);if(o){var a=r.cartesianToCartographic(o),s=i.Math.toDegrees(a.latitude),u=i.Math.toDegrees(a.longitude);c(e,{lat:s,lng:u})}}}},ie=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};a(this,t),this.opacity=1,this.visibility=!0,Object.assign(this,e,{changedAttributes:{}})}return e(t,[{key:"get",value:function(e){return this[e]}},{key:"set",value:function(e,t){return this[e]=t,this}},{key:"update",value:function(e){var t=this,i=y({},this),n=y({},e);this.set("changedAttributes",{}),Object.keys(n).forEach(function(e){r(i[e],n[e])||(t.changedAttributes[e]=n[e],t.set(e,n[e]))})}}]),t}();var ne=function(){function n(e,t){var i;a(this,n),this.map=e,this.plugin=new t(this.map),(i=this.plugin)&&["add","remove","setVisibility","setOpacity","setEvents","setZIndex","setLayerConfig","setParams","setDecodeParams","getLayerByProvider"].forEach(function(e){i[e]||console.error("The "+e+" function is required for layer manager plugins")}),this.layers=[],this.promises={}}return e(n,[{key:"renderLayers",value:function(){var s=this;return 0<this.layers.length?(this.layers.forEach(function(e){var t=e.changedAttributes,i=t.sqlParams,n=t.params,r=t.layerConfig,o=0<Object.keys(t).length,a=i||n||r;if(!a){if(e.mapLayer&&!o)return!1;if(e.mapLayer&&o)return s.updateLayer(e)}return e.mapLayer&&a&&s.updateLayer(e),s.requestLayer(e),e.set("changedAttributes",{})}),0===Object.keys(this.promises).length?Promise.resolve(this.layers):Promise.all(Object.values(this.promises)).then(function(){return s.layers}).then(function(){s.promises={}})):Promise.resolve(this.layers)}},{key:"add",value:function(e){var n=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{opacity:1,visibility:!0,zIndex:0,interactivity:null};return void 0===e?(console.error("layers is required"),this):Array.isArray(e)?(e.forEach(function(t){var e=n.layers.find(function(e){return e.id===t.id}),i=y({},t,r);e?e.update(i):n.layers.push(new ie(i))}),this.layers):(console.error("layers should be an array"),this)}},{key:"updateLayer",value:function(e){var t=e.changedAttributes,i=t.opacity,n=t.visibility,r=t.zIndex,o=t.params,a=t.sqlParams,s=t.decodeParams,u=t.layerConfig,c=t.events;void 0!==i&&this.plugin.setOpacity(e,i),void 0!==n&&this.plugin.setOpacity(e,n?e.opacity:0),void 0!==r&&this.plugin.setZIndex(e,r),void 0!==c&&this.setEvents(e),l(u)||this.plugin.setLayerConfig(e),l(o)||this.plugin.setParams(e),l(a)||this.plugin.setParams(e),l(s)||this.plugin.setDecodeParams(e)}},{key:"remove",value:function(e){var i=this,n=this.layers.slice(0),r=Array.isArray(e)?e:[e];this.layers.forEach(function(e,t){r?r.includes(e.id)&&(i.plugin.remove(e),n.splice(t,1)):i.plugin.remove(e)}),this.layers=r?n:[]}},{key:"setOpacity",value:function(t,i){var n=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){n.plugin.setOpacity(e,i)}):console.error("Can't find the layer")}},{key:"setVisibility",value:function(t,i){var n=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){n.plugin.setVisibility(e,i)}):console.error("Can't find the layer")}},{key:"setZIndex",value:function(t,i){var n=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){n.plugin.setZIndex(e,i)}):console.error("Can't find the layer")}},{key:"setEvents",value:function(e){e.events&&this.plugin.setEvents(e)}},{key:"requestLayer",value:function(t){var i=this,e=t.provider,n=this.plugin.getLayerByProvider(e);return n?(this.promises[t.id]&&this.promises[t.id].isPending&&this.promises[t.id].isPending()&&this.promises[t.id].cancel(),this.promises[t.id]=n.call(this,t).then(function(e){t.set("mapLayer",e),i.plugin.add(t),i.plugin.setZIndex(t,t.zIndex),i.plugin.setOpacity(t,t.opacity),i.plugin.setVisibility(t,t.visibility),i.setEvents(t)}),this):(this.promises[t.id]=Promise.reject(new Error(e+" provider is not yet supported.")),!1)}}]),n}();return ne.PluginLeaflet=t,ne.PluginCesium=ee,ne.replace=v,ne.substitution=s,ne.concatenation=u,ne});
